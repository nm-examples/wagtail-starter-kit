{% extends "wagtailadmin/base.html" %}
{% load static i18n wagtailadmin_tags %}

{% block titletag %}{% trans "Reorder" %} {{ model_verbose_name_plural }} - {{ block.super }}{% endblock %}

{% block content %}
    <div id="save-status" style="display: none;"></div>
    {% include "wagtailadmin/shared/header.html" with title="Reorder "|add:model_verbose_name_plural icon="list-ul" %}

    <div class="nice-padding">
        {% if object_list %}
            <div class="help-block help-info">
                <svg class="icon icon-help icon" aria-hidden="true"><use href="#icon-help"></use></svg>
                <p>{% trans "Drag and drop a" %} {{ model_verbose_name|lower }} {% trans "below to change it's order. Changes are saved automatically." %}</p>
            </div>


            <div class="listing">
                <ul class="listing__list" id="developerskill-list">
                    {% for skill in object_list %}
                    <li class="listing__item" data-id="{{ skill.id }}">
                        <div class="listing__item__drag-handle drag-handle" style="cursor: grab;">
                            {% icon name="grip" %}
                        </div>
                        <div class="listing__item__content">
                            <h2 class="listing__item__title">{{ skill.name }}</h2>
                          </div>
                          <div class="listing__item__actions">
                            <a href="#" class="button button-small button--icon button-secondary">
                              <span class="icon-wrapper"><svg class="icon icon-arrow-up icon" aria-hidden="true"><use href="#icon-arrow-up"></use></svg></span>
                              Move First
                            </a>
                            <a href="#" class="button button-small button--icon button-secondary">
                              <span class="icon-wrapper"><svg class="icon icon-arrow-down icon" aria-hidden="true"><use href="#icon-arrow-down"></use></svg></span>
                              Move Last
                            </a>
                          </div>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <div class="action-buttons">
                <a href="{% url 'wagtailsnippets_portfolio_developerskill:list' %}" class="button button-secondary button--icon">
                    {% icon name="arrow-left" %}
                    {% trans "Back to" %} {{ model_verbose_name_plural }}
                </a>
            </div>
        {% else %}
            <div class="nice-padding">
                <p>{% trans "No" %} {{ model_verbose_name_plural|lower }} {% trans "found." %}</p>
                <a href="{% url 'wagtailsnippets_portfolio_developerskill:list' %}" class="button button-secondary">
                    {% trans "Back to" %} {{ model_verbose_name_plural }}
                </a>
            </div>
        {% endif %}
    </div>
  <script type="module">
    import Sortable from "https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/+esm";

    document.addEventListener('DOMContentLoaded', function() {
      const skillList = document.getElementById('developerskill-list');
      const saveStatus = document.getElementById('save-status');
      let isSaving = false;

      // Function to show status message
      function showStatus(message, type) {
        saveStatus.innerHTML = `
          <div class="messages">
            <div class="message ${type}">
              <a href="#" class="icon icon-${type === 'success' ? 'success' : 'warning'}"></a>
              <p>${message}</p>
            </div>
          </div>
        `;
        saveStatus.style.display = 'block';

        // Hide after 3 seconds
        setTimeout(() => {
          saveStatus.style.display = 'none';
        }, 3000);
      }

      // Function to save the order
      function saveOrder() {
        if (isSaving) return; // Prevent multiple simultaneous saves

        const items = skillList.querySelectorAll("li");
        const order = Array.from(items).map((item, idx) => ({
          id: item.getAttribute("data-id"),
          sort_order: idx + 1
        }));

        isSaving = true;

        fetch("{% url 'wagtailsnippets_portfolio_developerskill:reorder' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
          },
          body: JSON.stringify({order: order}),
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showStatus("Order saved successfully", "success");
          } else {
            console.error("Error saving order:", data.error || "Unknown error");
            showStatus("Error saving order: " + (data.error || "Unknown error"), "error");
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showStatus("Error saving order", "error");
        })
        .finally(() => {
          isSaving = false;
        });
      }

      // Initialize Sortable with auto-save on end
      const sortable = Sortable.create(skillList, {
        handle: ".listing__item__drag-handle",
        animation: 150,
        ghostClass: "sortable-ghost",
        chosenClass: "sortable-chosen",
        dragClass: "sortable-drag",
        onEnd: function() {
          // Auto-save when drag ends
          saveOrder();
        }
      });
    });
  </script>
{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <style>
        .listing__item__drag-handle {
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.6;
            transition: opacity 0.2s ease;
            width: 40px;
            height: 40px;
            flex-shrink: 0;
        }

        .listing__item__drag-handle svg {
            width: 14px;
            height: 14px;
        }

        .listing__item__drag-handle:hover {
            opacity: 1;
        }

        .listing__item__drag-handle:active {
            cursor: grabbing;
        }

        .sortable-ghost {
            opacity: 0.4;
            background-color: #f0f0f0;
        }

        .sortable-chosen {
            background-color: #e3f2fd;
        }

        .sortable-drag {
            opacity: 0.8;
            transform: rotate(5deg);
        }

        .action-buttons {
            margin-top: 1.5rem;
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .listing__list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .listing__item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.25rem;
            border: 1px solid #e1e5e9;
            border-radius: 4px;
            margin-bottom: 0.25rem;
            background: white;
            transition: all 0.2s ease;
        }

        .listing__item__actions {
            transform: translateX(-10px);
        }

        .listing__item:hover {
            border-color: #007cba;
            box-shadow: 0 2px 4px rgba(0, 123, 186, 0.1);
        }

        .listing__item__content {
            flex: 1;
            display: flex;
            align-items: right;
        }

        .listing__item__title {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
            color: #333;
        }

        .listing {
            width: 100%;
        }

        /* Success message styling based on help-block help-info */
        #save-status .messages {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            margin-bottom: 0;
        }

        #save-status .message {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            border-radius: 4px;
            margin: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            min-width: 200px;
        }

        #save-status .message.success {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }

        #save-status .message.error {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }

        #save-status .message a {
            flex-shrink: 0;
            margin-top: 0.125rem;
        }

        #save-status .message p {
            margin: 0;
            flex: 1;
        }
    </style>
{% endblock %}
