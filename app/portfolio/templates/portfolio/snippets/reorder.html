{% extends "wagtailadmin/base.html" %}
{% load static i18n wagtailadmin_tags %}

{% block titletag %}{% trans "Reorder Developer Skills" %} - {{ block.super }}{% endblock %}

{% block content %}
    {% include "wagtailadmin/shared/header.html" with title="Reorder Developer Skills" icon="list-ul" %}

    <div class="nice-padding">
        {% if object_list %}
            <div class="help-block help-info">
                <svg class="icon icon-help icon" aria-hidden="true"><use href="#icon-help"></use></svg>
                <p>{% trans "Drag and drop the skills below to change their order. Changes are saved automatically." %}</p>
            </div>

            <div id="save-status" style="display: none;"></div>

            <div class="listing">
                <table class="listing__table" id="developerskill-table">
                    <thead>
                        <tr class="table-headers">
                            <th class="ord">{% trans "Order" %}</th>
                            <th>{% trans "Name" %}</th>
                            <th>{% trans "Level" %}</th>
                        </tr>
                    </thead>
                    <tbody id="sortable-tbody">
                        {% for skill in object_list %}
                        <tr class="listing__item" data-id="{{ skill.id }}">
                            <td class="ord">
                                <div class="listing__item__drag-handle drag-handle" style="cursor: grab;">
                                    {% icon name="grip" %}
                                </div>
                            </td>
                            <td class="title">
                                <h2>{{ skill.name }}</h2>
                            </td>
                            <td>
                                <span class="status-tag primary">{{ skill.get_level_display }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="action-buttons">
                <a href="{% url 'wagtailsnippets_portfolio_developerskill:list' %}" class="button button-secondary button--icon">
                    {% icon name="arrow-left" %}
                    {% trans "Back to Skills" %}
                </a>
            </div>
        {% else %}
            <div class="nice-padding">
                <p>{% trans "No developer skills found." %}</p>
                <a href="{% url 'wagtailsnippets_portfolio_developerskill:list' %}" class="button button-secondary">
                    {% trans "Back to Skills" %}
                </a>
            </div>
        {% endif %}
    </div>
  <script type="module">
    import Sortable from "https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/+esm";

    document.addEventListener('DOMContentLoaded', function() {
      const tbody = document.getElementById('sortable-tbody');
      const saveStatus = document.getElementById('save-status');
      let isSaving = false;

      // Function to show status message
      function showStatus(message, type) {
        saveStatus.innerHTML = `
          <div class="messages">
            <div class="message ${type}">
              <a href="#" class="icon icon-${type === 'success' ? 'success' : 'warning'}"></a>
              <p>${message}</p>
            </div>
          </div>
        `;
        saveStatus.style.display = 'block';
        
        // Hide after 3 seconds
        setTimeout(() => {
          saveStatus.style.display = 'none';
        }, 3000);
      }

      // Function to save the order
      function saveOrder() {
        if (isSaving) return; // Prevent multiple simultaneous saves
        
        const rows = tbody.querySelectorAll("tr");
        const order = Array.from(rows).map((row, idx) => ({
          id: row.getAttribute("data-id"),
          sort_order: idx + 1
        }));

        isSaving = true;

        fetch("{% url 'wagtailsnippets_portfolio_developerskill:reorder' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
          },
          body: JSON.stringify({order: order}),
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showStatus("Order saved successfully", "success");
          } else {
            console.error("Error saving order:", data.error || "Unknown error");
            showStatus("Error saving order: " + (data.error || "Unknown error"), "error");
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showStatus("Error saving order", "error");
        })
        .finally(() => {
          isSaving = false;
        });
      }

      // Initialize Sortable with auto-save on end
      const sortable = Sortable.create(tbody, {
        handle: ".listing__item__drag-handle",
        animation: 150,
        ghostClass: "sortable-ghost",
        chosenClass: "sortable-chosen",
        dragClass: "sortable-drag",
        onEnd: function() {
          // Auto-save when drag ends
          saveOrder();
        }
      });
    });
  </script>
{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <style>
        .listing__item__drag-handle {
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.6;
            transition: opacity 0.2s ease;
            width: 100%;
            height: 100%;
            min-height: 50px;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .listing__item__drag-handle svg {
            width: 14px;
            height: 14px;
        }

        .listing__item__drag-handle:hover {
            opacity: 1;
        }

        .listing__item__drag-handle:active {
            cursor: grabbing;
        }

        .sortable-ghost {
            opacity: 0.4;
            background-color: #f0f0f0;
        }

        .sortable-chosen {
            background-color: #e3f2fd;
        }

        .sortable-drag {
            opacity: 0.8;
            transform: rotate(5deg);
        }

        .action-buttons {
            margin-top: 1.5rem;
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .status-tag {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: capitalize;
        }

        .status-tag.primary {
            background-color: #007cba;
            color: white;
        }

        .listing__table th.ord,
        .listing__table td.ord {
            width: 60px;
            text-align: center;
            padding: 0;
            position: relative;
        }

        .listing__table td.title h2 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .listing {
            width: 100%;
        }

        .listing__table {
            width: 100%;
            table-layout: fixed;
        }

        .listing__table th,
        .listing__table td {
            padding: 1rem 0.75rem;
        }

        .listing__table th:nth-child(2),
        .listing__table td:nth-child(2) {
            width: 50%;
        }

        .listing__table th:nth-child(3),
        .listing__table td:nth-child(3) {
            width: calc(50% - 60px);
        }

        /* Success message styling based on help-block help-info */
        #save-status .messages {
            margin-bottom: 1.5rem;
        }

        #save-status .message {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            border-radius: 4px;
            margin: 0;
        }

        #save-status .message.success {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }

        #save-status .message.error {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }

        #save-status .message a {
            flex-shrink: 0;
            margin-top: 0.125rem;
        }

        #save-status .message p {
            margin: 0;
            flex: 1;
        }
    </style>
{% endblock %}
