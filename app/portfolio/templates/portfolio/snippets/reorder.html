{% extends "wagtailadmin/base.html" %}
{% load static i18n wagtailadmin_tags %}

{% block titletag %}{% trans "Reorder Developer Skills" %} - {{ block.super }}{% endblock %}

{% block content %}
    {% include "wagtailadmin/shared/header.html" with title="Reorder Developer Skills" icon="list-ul" %}

    <div class="nice-padding">
        {% if object_list %}
            <div class="help-block">
                <p>{% trans "Drag and drop the skills below to change their order. Changes are saved automatically." %}</p>
            </div>

            <div class="listing">
                <table class="listing__table" id="developerskill-table">
                    <thead>
                        <tr class="table-headers">
                            <th class="ord">{% trans "Order" %}</th>
                            <th>{% trans "Name" %}</th>
                            <th>{% trans "Level" %}</th>
                        </tr>
                    </thead>
                    <tbody id="sortable-tbody">
                        {% for skill in object_list %}
                        <tr class="listing__item" data-id="{{ skill.id }}">
                            <td class="ord">
                                <div class="listing__item__drag-handle drag-handle" style="cursor: grab;">
                                    {% icon name="grip" %}
                                </div>
                            </td>
                            <td class="title">
                                <h2>{{ skill.name }}</h2>
                            </td>
                            <td>
                                <span class="status-tag primary">{{ skill.get_level_display }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="action-buttons">
                <a href="{% url 'wagtailsnippets_portfolio_developerskill:list' %}" class="button button-secondary button--icon">
                    {% icon name="arrow-left" %}
                    {% trans "Back to Skills" %}
                </a>
            </div>
        {% else %}
            <div class="nice-padding">
                <p>{% trans "No developer skills found." %}</p>
                <a href="{% url 'wagtailsnippets_portfolio_developerskill:list' %}" class="button button-secondary">
                    {% trans "Back to Skills" %}
                </a>
            </div>
        {% endif %}
    </div>
  <script type="module">
    import Sortable from "https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/+esm";

    document.addEventListener('DOMContentLoaded', function() {
      const tbody = document.getElementById('sortable-tbody');
      let isSaving = false;

      // Function to save the order
      function saveOrder() {
        if (isSaving) return; // Prevent multiple simultaneous saves
        
        const rows = tbody.querySelectorAll("tr");
        const order = Array.from(rows).map((row, idx) => ({
          id: row.getAttribute("data-id"),
          sort_order: idx + 1
        }));

        isSaving = true;

        fetch("{% url 'wagtailsnippets_portfolio_developerskill:reorder' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
          },
          body: JSON.stringify({order: order}),
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Show brief success indicator
            const successIndicator = document.createElement('div');
            successIndicator.className = 'save-success-indicator';
            successIndicator.innerHTML = '<span class="icon icon-success"></span> Order saved';
            successIndicator.style.cssText = `
              position: fixed;
              top: 20px;
              right: 20px;
              background: #28a745;
              color: white;
              padding: 0.5rem 1rem;
              border-radius: 4px;
              z-index: 1000;
              font-size: 0.875rem;
              display: flex;
              align-items: center;
              gap: 0.5rem;
              box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            `;
            document.body.appendChild(successIndicator);
            
            // Remove indicator after 2 seconds
            setTimeout(() => {
              if (successIndicator.parentNode) {
                successIndicator.parentNode.removeChild(successIndicator);
              }
            }, 2000);
          } else {
            console.error("Error saving order:", data.error || "Unknown error");
            // Show error indicator
            const errorIndicator = document.createElement('div');
            errorIndicator.className = 'save-error-indicator';
            errorIndicator.innerHTML = '<span class="icon icon-warning"></span> Error saving order';
            errorIndicator.style.cssText = `
              position: fixed;
              top: 20px;
              right: 20px;
              background: #dc3545;
              color: white;
              padding: 0.5rem 1rem;
              border-radius: 4px;
              z-index: 1000;
              font-size: 0.875rem;
              display: flex;
              align-items: center;
              gap: 0.5rem;
              box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            `;
            document.body.appendChild(errorIndicator);
            
            // Remove indicator after 3 seconds
            setTimeout(() => {
              if (errorIndicator.parentNode) {
                errorIndicator.parentNode.removeChild(errorIndicator);
              }
            }, 3000);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          // Show error indicator
          const errorIndicator = document.createElement('div');
          errorIndicator.className = 'save-error-indicator';
          errorIndicator.innerHTML = '<span class="icon icon-warning"></span> Error saving order';
          errorIndicator.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            z-index: 1000;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
          `;
          document.body.appendChild(errorIndicator);
          
          // Remove indicator after 3 seconds
          setTimeout(() => {
            if (errorIndicator.parentNode) {
              errorIndicator.parentNode.removeChild(errorIndicator);
            }
          }, 3000);
        })
        .finally(() => {
          isSaving = false;
        });
      }

      // Initialize Sortable with auto-save on end
      const sortable = Sortable.create(tbody, {
        handle: ".listing__item__drag-handle",
        animation: 150,
        ghostClass: "sortable-ghost",
        chosenClass: "sortable-chosen",
        dragClass: "sortable-drag",
        onEnd: function() {
          // Auto-save when drag ends
          saveOrder();
        }
      });
    });
  </script>
{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <style>
        .listing__item__drag-handle {
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.6;
            transition: opacity 0.2s ease;
            width: 100%;
            height: 100%;
            min-height: 50px;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .listing__item__drag-handle svg {
            width: 14px;
            height: 14px;
        }

        .listing__item__drag-handle:hover {
            opacity: 1;
        }

        .listing__item__drag-handle:active {
            cursor: grabbing;
        }

        .sortable-ghost {
            opacity: 0.4;
            background-color: #f0f0f0;
        }

        .sortable-chosen {
            background-color: #e3f2fd;
        }

        .sortable-drag {
            opacity: 0.8;
            transform: rotate(5deg);
        }

        .action-buttons {
            margin-top: 1.5rem;
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .help-block {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-left: 4px solid #007cba;
            border-radius: 4px;
        }

        .help-block p {
            margin: 0;
            color: #666;
        }

        .status-tag {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 500;
            text-transform: capitalize;
        }

        .status-tag.primary {
            background-color: #007cba;
            color: white;
        }

        .listing__table th.ord,
        .listing__table td.ord {
            width: 60px;
            text-align: center;
            padding: 0;
            position: relative;
        }

        .listing__table td.title h2 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .listing {
            width: 100%;
        }

        .listing__table {
            width: 100%;
            table-layout: fixed;
        }

        .listing__table th,
        .listing__table td {
            padding: 1rem 0.75rem;
        }

        .listing__table th:nth-child(2),
        .listing__table td:nth-child(2) {
            width: 50%;
        }

        .listing__table th:nth-child(3),
        .listing__table td:nth-child(3) {
            width: calc(50% - 60px);
        }
    </style>
{% endblock %}
